
param(
    [Switch] $openSite
)

# Embedded file data
$fileDatas = @{
	'/index.css' = @{ 'Content' = [Byte[]] @( 13,10,42,32,123,13,10,32,32,32,32,116,101,120,116,45,97,108,105,103,110,58,32,99,101,110,116,101,114,59,13,10,32,32,32,32,99,111,108,111,114,58,32,114,103,98,40,55,48,44,32,55,48,44,32,55,49,41,59,13,10,125 ); 'ContentType' = 'text/css' }
	'/index.html' = @{ 'Content' = [Byte[]] @( 13,10,60,33,68,79,67,84,89,80,69,32,104,116,109,108,62,13,10,60,104,116,109,108,32,108,97,110,103,61,34,101,110,34,32,100,105,114,61,34,108,116,114,34,62,13,10,32,32,60,104,101,97,100,62,13,10,32,32,32,32,60,109,101,116,97,32,99,104,97,114,115,101,116,61,34,85,84,70,45,56,34,32,47,62,13,10,32,32,32,32,60,108,105,110,107,32,114,101,108,61,34,105,99,111,110,34,32,104,114,101,102,61,34,102,97,118,105,99,111,110,46,105,99,111,34,32,116,121,112,101,61,34,105,109,97,103,101,47,120,45,105,99,111,110,34,32,47,62,13,10,32,32,32,32,60,108,105,110,107,32,114,101,108,61,34,115,116,121,108,101,115,104,101,101,116,34,32,116,121,112,101,61,34,116,101,120,116,47,99,115,115,34,32,104,114,101,102,61,34,105,110,100,101,120,46,99,115,115,34,32,47,62,13,10,32,32,32,32,60,115,99,114,105,112,116,32,115,114,99,61,34,105,110,100,101,120,46,106,115,34,62,60,47,115,99,114,105,112,116,62,13,10,32,32,32,32,60,116,105,116,108,101,62,66,97,115,105,99,32,87,101,98,115,105,116,101,60,47,116,105,116,108,101,62,13,10,32,32,60,47,104,101,97,100,62,13,10,13,10,32,32,60,98,111,100,121,62,13,10,32,32,32,32,60,104,49,62,84,104,105,115,32,105,115,32,116,104,101,32,116,105,116,108,101,60,47,104,49,62,13,10,32,32,32,32,60,112,62,83,111,109,101,32,99,111,110,116,101,110,116,32,105,110,32,116,104,101,32,109,105,100,100,108,101,46,60,47,112,62,13,10,32,32,32,32,60,97,32,104,114,101,102,61,34,97,47,97,46,104,116,109,108,34,62,83,117,98,32,112,97,103,101,60,47,97,62,13,10,32,32,60,47,98,111,100,121,62,13,10,60,47,104,116,109,108,62,13,10 ); 'ContentType' = 'text/html' }
	'/index.js' = @{ 'Content' = [Byte[]] @( 13,10,99,111,110,115,111,108,101,46,108,111,103,40,34,72,101,108,108,111,34,41 ); 'ContentType' = 'application/javascript' }
	'/a/a.html' = @{ 'Content' = [Byte[]] @( 13,10,60,33,68,79,67,84,89,80,69,32,104,116,109,108,62,13,10,60,104,116,109,108,32,108,97,110,103,61,34,101,110,34,32,100,105,114,61,34,108,116,114,34,62,13,10,32,32,60,104,101,97,100,62,13,10,32,32,32,32,60,109,101,116,97,32,99,104,97,114,115,101,116,61,34,85,84,70,45,56,34,32,47,62,13,10,32,32,32,32,60,108,105,110,107,32,114,101,108,61,34,105,99,111,110,34,32,104,114,101,102,61,34,46,46,47,102,97,118,105,99,111,110,46,105,99,111,34,32,116,121,112,101,61,34,105,109,97,103,101,47,120,45,105,99,111,110,34,32,47,62,13,10,32,32,32,32,60,108,105,110,107,32,114,101,108,61,34,115,116,121,108,101,115,104,101,101,116,34,32,116,121,112,101,61,34,116,101,120,116,47,99,115,115,34,32,104,114,101,102,61,34,46,46,47,105,110,100,101,120,46,99,115,115,34,32,47,62,13,10,32,32,32,32,60,116,105,116,108,101,62,83,117,98,32,80,97,103,101,60,47,116,105,116,108,101,62,13,10,32,32,60,47,104,101,97,100,62,13,10,13,10,32,32,60,98,111,100,121,62,13,10,32,32,32,32,60,104,49,62,84,104,105,115,32,105,115,32,116,104,101,32,115,117,98,32,112,97,103,101,60,47,104,49,62,13,10,32,32,32,32,60,112,62,83,111,109,101,32,115,117,98,32,112,97,103,101,32,99,111,110,116,101,110,116,46,60,47,112,62,13,10,32,32,60,47,98,111,100,121,62,13,10,60,47,104,116,109,108,62,13,10 ); 'ContentType' = 'text/html' }
}

# Setup server
$http = [System.Net.HttpListener]::new() 
$http.Prefixes.Add("http://localhost:8080/")
$http.Start()

if ($http.IsListening) {
    write-host " HTTP Server Ready!  " -f 'black' -b 'gre'
    write-host "Listening at $($http.Prefixes)..." -f 'y'
    if ($openSite) {
        Start-Process $http.Prefixes
    }
}

# Helper functions
function CompareRequest {
    param($context, $method, $path);
    return $context.Request.HttpMethod -eq $method -and $context.Request.Url.LocalPath -like $path
}
function RequestFile {
    param($context, $localPath);
    if (!$fileDatas.ContainsKey($localPath)) { Write-Warning "Do not have file '$localPath'"; return }
    RespondByteData $context $fileDatas.$localPath.Content $fileDatas.$localPath.ContentType
}

function RespondByteData {
    param($context, $bytes, $type);
    $context.Response.ContentLength64 = $bytes.Length
    $context.Response.ContentType = $type
    $context.Response.OutputStream.Write($bytes, 0, $bytes.Length)
    $context.Response.OutputStream.Close()
}

# Listener loop
while ($http.IsListening) {
    $context = $http.GetContext()
    
    Write-Host "'$($context.Request.UserHostAddress)' requested '$($Context.Request.Url.LocalPath)' ( $($context.Request.Url) )" -f 'mag'

    # http://127.0.0.1/exit
    if (CompareRequest $context "GET" "/exit") { exit }
    
    # http://127.0.0.1/*
    elseif (CompareRequest $context "GET" "/*") {
        $localPath = $context.Request.Url.LocalPath
        if ($localPath -eq "/") { $localPath = "/index.html" }
        RequestFile $context $localPath
    }
}

# $FormContent = [System.IO.StreamReader]::new($context.Request.InputStream).ReadToEnd()
# Write-Host $FormContent -f 'Green'
